<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiskMaster</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: Arial, sans-serif; 
      color: #f0f0f0; 
      overflow-x: hidden; 
      background: url('https://images.unsplash.com/photo-1518562180175-34a163b1c9c9?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed; 
      background-size: cover; 
      position: relative; 
      transition: all 0.3s ease;
    }
    body::before { 
      content: ''; 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.5); 
      z-index: -1; 
    }
    .nav-container { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: rgba(44, 44, 44, 0.9); 
      padding: 10px; 
      position: sticky; 
      top: 0; 
      z-index: 1000; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.5); 
      transition: padding 0.3s ease;
    }
    .nav-left { display: flex; align-items: center; }
    .dropdown { position: relative; display: inline-block; margin-right: 15px; }
    .dropbtn { 
      background: linear-gradient(135deg, #4a90e2, #357abd); 
      color: white; 
      padding: 12px 20px; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      font-size: 14px; 
      font-weight: bold; 
      box-shadow: 0 3px 6px rgba(0,0,0,0.3); 
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    .dropbtn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .dropdown-content { 
      display: none; 
      position: absolute; 
      background: rgba(44, 44, 44, 0.9); 
      min-width: 160px; 
      box-shadow: 0 8px 16px rgba(0,0,0,0.5); 
      z-index: 1; 
      border-radius: 10px; 
      opacity: 0; 
      transform: translateY(-10px); 
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .dropdown-content.show { 
      display: block; 
      opacity: 1; 
      transform: translateY(0); 
    }
    .dropdown-content button { 
      color: white; 
      padding: 12px 16px; 
      text-decoration: none; 
      display: block; 
      border: none; 
      background: none; 
      width: 100%; 
      text-align: left; 
      cursor: pointer; 
      font-size: 14px; 
      transition: background 0.3s ease;
    }
    .dropdown-content button:hover { background: rgba(58, 58, 58, 0.9); }
    .section-title { font-size: 16px; font-weight: bold; color: #f0f0f0; }
    .section { 
      display: none; 
      padding: 15px; 
      background: rgba(36, 36, 36, 0.9); 
      min-height: 100vh; 
      opacity: 0; 
      transform: translateY(20px); 
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .section.active { 
      display: block; 
      opacity: 1; 
      transform: translateY(0); 
    }
    .form { 
      max-width: 100%; 
      margin: 15px auto; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      background: rgba(44, 44, 44, 0.9); 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
      transition: transform 0.3s ease;
    }
    .form:hover { transform: translateY(-5px); }
    .form label { 
      color: #f0f0f0; 
      font-size: 14px; 
      font-weight: bold; 
      margin-bottom: 5px; 
    }
    .form input, .form textarea { 
      padding: 12px; 
      border: none; 
      border-radius: 8px; 
      background: #333; 
      color: #f5f5f5; 
      font-size: 14px; 
      transition: box-shadow 0.3s ease, transform 0.2s ease;
    }
    .form input:focus, .form textarea:focus { 
      outline: none; 
      box-shadow: 0 0 5px #4a90e2; 
      transform: scale(1.02);
    }
    .form button { 
      background: linear-gradient(135deg, #4a90e2, #357abd); 
      padding: 12px; 
      border: none; 
      border-radius: 10px; 
      color: white; 
      cursor: pointer; 
      font-size: 14px; 
      font-weight: bold; 
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    }
    .form button:hover { 
      transform: scale(1.02); 
      box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
    }
    .photo-preview { 
      display: flex; 
      flex-wrap: nowrap;
      gap: 10px; 
      margin-top: 10px; 
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 5px; 
    }
    .photo-preview img { 
      max-width: 100%;
      height: auto;
      max-height: 150px;
      object-fit: contain; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }
    .photo-preview img:hover { transform: scale(1.1); }
    .order-list { 
      display: grid; 
      gap: 15px; 
      padding: 10px; 
    }
    .order-card { 
      background: rgba(44, 44, 44, 0.9); 
      padding: 10px; 
      border-radius: 12px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
      transition: transform 0.3s ease;
      animation: slideIn 0.5s ease-in-out; 
      font-size: 14px; 
    }
    .order-card:hover { transform: translateY(-5px); }
    .order-card p { 
      color: #d4af37;
    }
    .order-card .photos { 
      display: flex; 
      flex-wrap: nowrap;
      gap: 5px; 
      margin: 5px 0; 
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 5px; 
    }
    .order-card img { 
      max-width: 100%;
      height: auto;
      max-height: 100px;
      object-fit: contain; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }
    .order-card img:hover { transform: scale(1.1); }
    .order-card details { 
      margin-top: 5px; 
      color: #f0f0f0; 
      transition: all 0.3s ease;
    }
    .order-card summary { 
      cursor: pointer; 
      font-weight: bold; 
      color: #d4af37;
    }
    .order-card textarea { 
      width: 100%; 
      padding: 10px; 
      border: none; 
      border-radius: 8px; 
      background: #333; 
      color: #f5f5f5; 
      font-size: 14px; 
      resize: none; 
      transition: box-shadow 0.3s ease;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); 
    }
    .order-card textarea:focus { 
      outline: none; 
      box-shadow: 0 0 5px #4a90e2; 
    }
    .order-card button { 
      margin-top: 10px; 
      background: linear-gradient(135deg, #4a90e2, #357abd); 
      padding: 10px; 
      border: none; 
      border-radius: 10px; 
      color: white; 
      cursor: pointer; 
      font-size: 14px; 
      font-weight: bold; 
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3); 
    }
    .order-card button:hover { 
      transform: scale(1.02); 
      box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
    }
    .services-checkboxes { 
      display: flex; 
      flex-direction: column; 
      gap: 5px; 
      margin-top: 5px; 
    }
    .services-checkboxes label { 
      display: flex; 
      align-items: center; 
      gap: 5px; 
    }
    .modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.9); 
      z-index: 2000; 
      justify-content: center; 
      align-items: center; 
      opacity: 0; 
      transition: opacity 0.3s ease;
      overflow-y: auto;
      padding: 20px;
    }
    .modal.active { 
      display: flex; 
      opacity: 1; 
    }
    .modal img { 
      max-width: 100%;
      max-height: 80vh;
      width: auto;
      height: auto;
      border-radius: 10px; 
      transition: transform 0.3s ease;
      object-fit: contain;
    }
    .modal-close-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 2001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }
    .modal-close-btn:hover {
      transform: scale(1.1);
    }
    .modal-content {
      width: 100%;
      max-width: 800px;
      background: rgba(36, 36, 36, 0.95);
      border-radius: 12px;
      padding: 20px;
      position: relative;
    }
    .pagination { 
      display: flex; 
      justify-content: center; 
      gap: 10px; 
      margin: 15px 0; 
    }
    .pagination button { 
      padding: 10px; 
      background: linear-gradient(135deg, #4a90e2, #357abd); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: background 0.3s ease, transform 0.2s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3); 
    }
    .pagination button:disabled { 
      background: #666; 
      cursor: not-allowed; 
      box-shadow: none; 
    }
    #loading { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: rgba(0,0,0,0.8); 
      padding: 20px; 
      border-radius: 12px; 
      display: none; 
      color: #fff; 
      font-size: 16px; 
      z-index: 3000; 
      transition: opacity 0.3s ease;
    }
    #loading.active { opacity: 1; }
    .existing-photos { 
      display: flex; 
      flex-wrap: nowrap;
      gap: 10px; 
      margin-top: 10px; 
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 5px; 
    }
    .existing-photo-container {
      position: relative;
      display: inline-block;
      margin-right: 10px;
    }
    .existing-photo-container img { 
      max-width: 100%;
      height: auto;
      max-height: 100px;
      object-fit: contain; 
      border-radius: 8px; 
      transition: transform 0.2s ease;
    }
    .existing-photo-container img:hover { transform: scale(1.1); }
    .existing-photo-container button { 
      position: absolute; 
      top: 0; 
      right: 0; 
      background: #666; 
      padding: 2px; 
      font-size: 12px; 
      border-radius: 50%; 
      width: 20px; 
      height: 20px; 
      line-height: 10px; 
      transition: transform 0.2s ease, background 0.3s ease;
      border: none;
      color: white;
      cursor: pointer;
    }
    .existing-photo-container button:hover { 
      transform: scale(1.1); 
      background: #e74c3c;
    }

    @media (max-width: 600px) {
      .nav-container { 
        flex-direction: column; 
        align-items: flex-start; 
        padding: 5px;
      }
      .nav-left { 
        width: 100%; 
        justify-content: space-between; 
      }
      .dropdown { margin-right: 0; }
      .dropbtn { 
        padding: 10px 15px; 
        font-size: 12px;
      }
      .dropdown-content { 
        min-width: 100%;
        left: 0; 
      }
      .section { padding: 10px; }
      .form { 
        padding: 15px; 
        gap: 10px;
      }
      .form input, .form textarea { 
        padding: 10px; 
        font-size: 12px;
      }
      .form button { 
        padding: 10px; 
        font-size: 12px;
      }
      .order-list { gap: 10px; }
      .order-card { 
        font-size: 12px; 
        padding: 8px;
      }
      .order-card img, .photo-preview img, .existing-photos img { 
        max-height: 80px;
      }
      .order-card .photos, .photo-preview, .existing-photos { 
        -webkit-overflow-scrolling: touch;
      }
      .pagination button { 
        padding: 8px; 
        font-size: 12px;
      }
      .modal img { 
        max-width: 95vw;
        max-height: 70vh;
      }
      .modal-close-btn {
        width: 30px;
        height: 30px;
        font-size: 16px;
        top: 10px;
        right: 10px;
      }
      .modal-content {
        padding: 15px;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="loading">Загрузка...</div>
  <div class="nav-container" id="main-nav">
    <div class="nav-left">
      <div class="dropdown">
        <button class="dropbtn" onclick="App.toggleDropdown()">Меню</button>
        <div class="dropdown-content" id="dropdown-menu">
          <button data-section="new">Новый заказ</button>
          <button data-section="working">В работе</button>
          <button data-section="done">Готово</button>
          <button data-section="archive">Архив</button>
          <button data-section="search">Поиск</button>
          <button data-section="settings">Настройки</button>
        </div>
      </div>
      <span class="section-title" id="section-title">Новый заказ</span>
    </div>
  </div>
  <main>
    <section id="new-section" class="section active">
      <form id="order-form" class="form">
        <input type="text" name="clientName" placeholder="ФИО клиента" required>
        <input type="text" name="carNumber" placeholder="Госномер">
        <input type="tel" name="phone" placeholder="Телефон">
        <div class="services-checkboxes">
          <label><input type="checkbox" name="service" value="Покраска дисков"> Покраска дисков</label>
          <label><input type="checkbox" name="service" value="Правка геометрии"> Правка геометрии</label>
          <label><input type="checkbox" name="service" value="Димед"> Димед</label>
          <label><input type="checkbox" name="service" value="Иное"> Иное</label>
          <label><input type="checkbox" name="service" value="Пескоструйка"> Пескоструйка</label>
        </div>
        <input type="text" name="color" placeholder="Цвет (необязательно)">
        <textarea name="note" placeholder="Примечание"></textarea>
        <input type="number" name="cost" placeholder="Стоимость (руб)" required min="0" step="0.01">
        <input type="file" name="photos" id="photo-input" multiple accept="image/*" capture="environment">
        <div id="photo-preview" class="photo-preview"></div>
        <button type="submit">Создать заказ</button>
      </form>
    </section>
    <section id="working-section" class="section"><div id="working-list" class="order-list"></div></section>
    <section id="done-section" class="section"><div id="done-list" class="order-list"></div></section>
    <section id="archive-section" class="section"><div id="archive-list" class="order-list"></div></section>
    <section id="search-section" class="section">
      <div class="form">
        <input type="text" id="search-query" placeholder="Введите ключевое слово">
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <input type="date" id="search-start-date" placeholder="Дата начала">
          <input type="date" id="search-end-date" placeholder="Дата окончания">
        </div>
        <button onclick="App.searchOrders()">Поиск</button>
      </div>
      <div id="search-list" class="order-list"></div>
    </section>
    <section id="settings-section" class="section">
      <div class="form">
        <h2>Отчеты</h2>
        <form id="report-form" class="form">
          <input type="date" name="startDate" required>
          <input type="date" name="endDate" required>
          <button type="submit">Сформировать отчет о доходах</button>
        </form>
        <div id="report-result"></div>
      </div>
      <div class="form">
        <h2>Расходы</h2>
        <form id="add-expense-form" class="form">
          <input type="number" name="amount" placeholder="Сумма (руб)" required min="0" step="0.01">
          <textarea name="note" placeholder="Примечание" required></textarea>
          <button type="submit">Добавить расход</button>
        </form>
        <div id="expenses-list" class="order-list"></div>
        <form id="expense-report-form" class="form">
          <input type="date" name="startDate" required>
          <input type="date" name="endDate" required>
          <button type="submit">Сформировать отчет о расходах</button>
        </form>
        <div id="expense-report-result"></div>
        <form id="profit-report-form" class="form">
          <input type="date" name="startDate" required>
          <input type="date" name="endDate" required>
          <button type="submit">Сформировать отчет о прибыли</button>
        </form>
        <div id="profit-report-result"></div>
      </div>
    </section>
  </main>
  <div id="imageModal" class="modal">
    <button class="modal-close-btn" onclick="App.closeModal(null, 'imageModal')">×</button>
    <img id="modalImage" src="" alt="Фото">
  </div>
  <div id="archiveModal" class="modal">
    <button class="modal-close-btn" onclick="App.closeModal(null, 'archiveModal')">×</button>
    <form id="archive-form" class="form">
      <input type="file" name="finished_photos" id="archive-photo-input" multiple accept="image/*" capture="environment">
      <button type="button" onclick="App.addMoreArchivePhotos()">Добавить еще фото</button>
      <div id="archive-photo-preview" class="photo-preview"></div>
      <textarea name="comment" placeholder="Комментарий"></textarea>
      <button type="submit">Отправить в архив</button>
    </form>
  </div>
  <div id="editModal" class="modal"></div>
  <div id="addPhotosModal" class="modal"></div>
  <div id="orderModal" class="modal"></div>

  <script>
    const App = {
      currentOrderId: null,
      page: 1,
      perPage: 10,
      orders: [],
      expenses: [],
      username: 'admin',

      init() {
        document.addEventListener('DOMContentLoaded', () => {
          // Загружаем данные из localStorage
          this.loadFromLocalStorage();
          
          document.getElementById('order-form').addEventListener('submit', e => this.createOrder(e));
          document.getElementById('archive-form').addEventListener('submit', e => this.archiveOrder(e));
          document.getElementById('imageModal').addEventListener('click', e => this.closeModal(e, 'imageModal'));
          document.getElementById('archiveModal').addEventListener('click', e => this.closeModal(e, 'archiveModal'));
          document.getElementById('report-form').addEventListener('submit', e => this.generateIncomeReport(e));
          document.getElementById('add-expense-form').addEventListener('submit', e => this.addExpense(e));
          document.getElementById('expense-report-form').addEventListener('submit', e => this.generateExpenseReport(e));
          document.getElementById('profit-report-form').addEventListener('submit', e => this.generateProfitReport(e));
          document.getElementById('photo-input').addEventListener('change', e => this.previewPhotos(e));
          document.getElementById('archive-photo-input').addEventListener('change', e => this.previewArchivePhotos(e));
          
          document.querySelectorAll('.dropdown-content button').forEach(btn => {
            btn.addEventListener('click', () => {
              this.switchSection(btn.dataset.section);
              document.getElementById('dropdown-menu').classList.remove('show');
            });
          });

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
              });
            }
          });

          // Показываем раздел "Новый заказ" по умолчанию
          this.switchSection('new');
        });
      },

      loadFromLocalStorage() {
        const savedOrders = localStorage.getItem('diskMasterOrders');
        if (savedOrders) {
          this.orders = JSON.parse(savedOrders);
        }
        
        const savedExpenses = localStorage.getItem('diskMasterExpenses');
        if (savedExpenses) {
          this.expenses = JSON.parse(savedExpenses);
        }
      },

      saveToLocalStorage() {
        localStorage.setItem('diskMasterOrders', JSON.stringify(this.orders));
        localStorage.setItem('diskMasterExpenses', JSON.stringify(this.expenses));
      },

      toggleDropdown() {
        const dropdown = document.getElementById('dropdown-menu');
        dropdown.classList.toggle('show');
      },

      switchSection(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const section = document.getElementById(`${sectionId}-section`);
        section.classList.add('active');
        document.getElementById('section-title').textContent = this.getSectionTitle(sectionId);
        
        if (['working', 'done', 'archive'].includes(sectionId)) {
          this.page = 1;
          this.loadOrders(sectionId === 'working' ? 'В работе' : sectionId === 'done' ? 'Готово' : 'Архив');
        } else if (sectionId === 'settings') {
          this.loadExpenses();
        }
      },

      getSectionTitle(sectionId) {
        const titles = {
          new: 'Новый заказ',
          working: 'В работе',
          done: 'Готово',
          archive: 'Архив',
          search: 'Поиск',
          settings: 'Настройки'
        };
        return titles[sectionId] || '';
      },

      async compressImage(file, maxWidth = 1280, maxHeight = 720, quality = 0.6) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const reader = new FileReader();

          reader.onload = (e) => {
            img.src = e.target.result;
          };

          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width *= maxHeight / height;
                height = maxHeight;
              }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob(
              (blob) => {
                resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() }));
              },
              'image/jpeg',
              quality
            );
          };

          img.onerror = reject;
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      },

      async previewPhotos(event, previewId = 'photo-preview') {
        this.showLoading(true);
        try {
          const files = event.target.files;
          const preview = document.getElementById(previewId);
          preview.innerHTML = '';

          for (let i = 0; i < Math.min(files.length, 4); i++) {
            const compressedFile = await this.compressImage(files[i]);
            const img = document.createElement('img');
            img.src = URL.createObjectURL(compressedFile);
            preview.appendChild(img);
          }
        } catch (error) {
          console.error('Ошибка сжатия фото:', error);
          alert('Ошибка при обработке изображений');
        } finally {
          this.showLoading(false);
        }
      },

      async previewArchivePhotos(event) {
        this.showLoading(true);
        try {
          const files = event.target.files;
          const preview = document.getElementById('archive-photo-preview');
          preview.innerHTML = '';

          for (let i = 0; i < Math.min(files.length, 4); i++) {
            const compressedFile = await this.compressImage(files[i]);
            const img = document.createElement('img');
            img.src = URL.createObjectURL(compressedFile);
            preview.appendChild(img);
          }
        } catch (error) {
          console.error('Ошибка сжатия фото:', error);
          alert('Ошибка при обработке изображений');
        } finally {
          this.showLoading(false);
        }
      },

      addMoreArchivePhotos() {
        const input = document.getElementById('archive-photo-input');
        input.click();
      },

      async createOrder(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const photoInput = document.getElementById('photo-input');
        
        if (photoInput.files.length > 4) {
          console.warn('Превышено максимальное количество фото: ' + photoInput.files.length);
          alert('Максимум 4 фото!');
          return;
        }
        
        const selectedServices = Array.from(e.target.querySelectorAll('input[name="service"]:checked')).map(cb => cb.value).join(', ');
        if (!selectedServices) {
          console.warn('Не выбраны услуги при создании заказа');
          alert('Выберите хотя бы одну услугу!');
          return;
        }

        // Создаем новый заказ
        const newOrder = {
          id: Date.now(),
          full_name: formData.get('clientName'),
          car_number: formData.get('carNumber'),
          phone: formData.get('phone'),
          service: selectedServices,
          color: formData.get('color'),
          notes: formData.get('note'),
          cost: parseFloat(formData.get('cost')),
          status: 'В работе',
          created_at: new Date().toISOString(),
          created_by: this.username,
          photos: [],
          comments: '',
          finished_photos: []
        };

        // Обрабатываем фото
        const photoFiles = Array.from(photoInput.files);
        for (const file of photoFiles) {
          const compressedFile = await this.compressImage(file);
          const fileName = `photo_${Date.now()}_${Math.floor(Math.random() * 1000)}.jpg`;
          newOrder.photos.push(fileName);
        }

        // Добавляем заказ в массив
        this.orders.unshift(newOrder);
        this.saveToLocalStorage();

        console.log(`Заказ ${newOrder.id} успешно создан`);
        alert('Заказ создан!');
        e.target.reset();
        photoInput.value = '';
        document.getElementById('photo-preview').innerHTML = '';
        this.switchSection('working');
      },

      async loadOrders(status) {
        this.showLoading(true);
        try {
          const filteredOrders = this.orders.filter(order => order.status === status);
          console.log(`Загружено ${filteredOrders.length} заказов со статусом ${status}`);
          
          const list = document.getElementById(`${status === 'В работе' ? 'working' : status === 'Готово' ? 'done' : 'archive'}-list`);
          list.innerHTML = filteredOrders.length ? '' : '<p>Нет заказов</p>';
          
          // Пагинация
          const startIndex = (this.page - 1) * this.perPage;
          const paginatedOrders = filteredOrders.slice(startIndex, startIndex + this.perPage);
          
          paginatedOrders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card';
            
            const comments = order.comments ? order.comments.split(' | ').map(c => {
              const [date, rest] = c.split(': ');
              const [comment, username] = rest.split(' (');
              return `${date}: ${comment} (${username.slice(0, -1)})`;
            }).join('<br>') : 'Нет комментариев';
            
            const allPhotos = [...new Set([
              ...(order.photos || []),
              ...(order.finished_photos || [])
            ])];
            
            card.innerHTML = `
              <p><strong>Клиент:</strong> ${order.full_name}</p>
              <p><strong>Телефон:</strong> ${order.phone ? `<a href="tel:${order.phone}" style="color: #4a90e2;">${order.phone}</a>` : 'Не указан'}</p>
              <div class="photos">
                ${allPhotos.map(p => `<img src="${p}" onclick="App.showImage('${p}')">`).join('')}
              </div>
              <details>
                <summary>Подробности</summary>
                <p><strong>Заказ:</strong> ${order.id}</p>
                <p><strong>Госномер:</strong> ${order.car_number || 'Не указан'}</p>
                <p><strong>Услуги:</strong> ${order.service}</p>
                <p><strong>Стоимость:</strong> ${order.cost} руб</p>
                <p><strong>Создан:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                <p><strong>Создал:</strong> ${order.created_by}</p>
                <p><strong>Примечания:</strong> ${order.notes || 'Нет примечаний'}</p>
                <p><strong>Комментарии:</strong> ${comments}</p>
                <textarea placeholder="Комментарий"></textarea>
                <button onclick="App.addComment(${order.id}, this.previousElementSibling.value, '${status}')">Оставить комментарий</button>
                <button onclick="App.addPhotos(${order.id}, '${status}')">Добавить фото</button>
                <button onclick="App.editOrder(${order.id}, '${status}')">Редактировать</button>
              </details>
              ${status !== 'Архив' ? `
                <button onclick="App.moveOrder(${order.id}, '${status === 'В работе' ? 'Готово' : 'Архив'}', this.parentElement.querySelector('textarea').value)">
                  ${status === 'В работе' ? 'Заказ выполнен' : 'Передать клиенту'}</button>` : ''}
            `;
            list.appendChild(card);
          });
          
          this.renderPagination(filteredOrders.length, status);
        } catch (error) {
          console.error(`Ошибка загрузки заказов ${status}: ${error.message}`);
          alert('Ошибка загрузки: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async addComment(orderId, comment, status) {
        if (!comment.trim()) {
          console.warn('Попытка добавить пустой комментарий');
          alert('Введите комментарий');
          return;
        }
        
        this.showLoading(true);
        try {
          const order = this.orders.find(o => o.id === orderId);
          if (order) {
            const now = new Date();
            const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            const newComment = `${dateStr}: ${comment} (${this.username})`;
            
            if (order.comments) {
              order.comments += ' | ' + newComment;
            } else {
              order.comments = newComment;
            }
            
            this.saveToLocalStorage();
            console.log(`Комментарий добавлен к заказу ${orderId}`);
            this.loadOrders(status);
          }
        } catch (error) {
          console.error(`Ошибка добавления комментария к заказу ${orderId}: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async moveOrder(orderId, newStatus, comment) {
        const modal = document.getElementById('archiveModal');
        if (newStatus === 'Архив') {
          this.currentOrderId = orderId;
          modal.classList.add('active');
          document.getElementById('archive-form').querySelector('textarea').value = comment || '';
          return;
        }
        
        this.showLoading(true);
        try {
          const order = this.orders.find(o => o.id === orderId);
          if (order) {
            order.status = newStatus;
            
            if (comment) {
              const now = new Date();
              const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
              const newComment = `${dateStr}: ${comment} (${this.username})`;
              
              if (order.comments) {
                order.comments += ' | ' + newComment;
              } else {
                order.comments = newComment;
              }
            }
            
            this.saveToLocalStorage();
            console.log(`Заказ ${orderId} перемещен в ${newStatus}`);
            this.loadOrders(newStatus === 'Готово' ? 'В работе' : 'Готово');
          }
        } catch (error) {
          console.error(`Ошибка перемещения заказа ${orderId}: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async archiveOrder(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const photoInput = document.getElementById('archive-photo-input');
        
        if (photoInput.files.length > 4) {
          console.warn('Превышено максимальное количество фото при архивации: ' + photoInput.files.length);
          alert('Максимум 4 фото!');
          return;
        }
        
        this.showLoading(true);
        try {
          const order = this.orders.find(o => o.id === this.currentOrderId);
          if (order) {
            order.status = 'Архив';
            
            const comment = formData.get('comment');
            if (comment) {
              const now = new Date();
              const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
              const newComment = `${dateStr}: ${comment} (${this.username})`;
              
              if (order.comments) {
                order.comments += ' | ' + newComment;
              } else {
                order.comments = newComment;
              }
            }
            
            // Обрабатываем фото
            const photoFiles = Array.from(photoInput.files);
            for (const file of photoFiles) {
              const compressedFile = await this.compressImage(file);
              const fileName = `photo_${Date.now()}_${Math.floor(Math.random() * 1000)}.jpg`;
              order.finished_photos.push(fileName);
            }
            
            this.saveToLocalStorage();
            console.log(`Заказ ${this.currentOrderId} отправлен в архив`);
            document.getElementById('archiveModal').classList.remove('active');
            this.loadOrders('Готово');
          }
        } catch (error) {
          console.error(`Ошибка архивации заказа ${this.currentOrderId}: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async editOrder(orderId, status) {
        this.showLoading(true);
        try {
          const order = this.orders.find(o => o.id === orderId);
          if (!order) throw new Error('Заказ не найден');
          
          const modal = document.getElementById('editModal');
          const photosHtml = order.photos.map(p => `
            <div class="existing-photo-container">
              <img src="${p}" onclick="App.showImage('${p}')">
              <button onclick="App.removeExistingPhoto(${orderId}, '${p}', this.parentElement)">×</button>
            </div>
          `).join('');
          
          modal.innerHTML = `
            <button class="modal-close-btn" onclick="App.closeModal(null, 'editModal')">×</button>
            <form id="edit-form" class="form modal-content">
              <input type="text" name="clientName" value="${order.full_name}" placeholder="ФИО клиента" required>
              <input type="text" name="carNumber" value="${order.car_number || ''}" placeholder="Госномер">
              <input type="tel" name="phone" value="${order.phone || ''}" placeholder="Телефон">
              <input type="text" name="service" value="${order.service}" placeholder="Услуги" required>
              <input type="text" name="color" value="${order.color || ''}" placeholder="Цвет (необязательно)">
              <textarea name="note" placeholder="Примечание">${order.notes || ''}</textarea>
              <input type="number" name="cost" value="${order.cost}" placeholder="Стоимость (руб)" required min="0" step="0.01">
              <input type="file" name="photos" id="edit-photo-input" multiple accept="image/*" capture="environment">
              <div id="edit-photo-preview" class="photo-preview"></div>
              <div id="existing-photos" class="existing-photos">${photosHtml}</div>
              <button type="submit">Сохранить изменения</button>
            </form>
          `;
          
          modal.classList.add('active');
          document.getElementById('edit-photo-input').addEventListener('change', e => this.previewPhotos(e, 'edit-photo-preview'));
          document.getElementById('edit-form').addEventListener('submit', e => this.saveEditOrder(e, orderId, status));
        } catch (error) {
          console.error(`Ошибка загрузки данных заказа ${orderId}: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async saveEditOrder(e, orderId, status) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const photoInput = document.getElementById('edit-photo-input');
        
        if (photoInput.files.length > 4) {
          console.warn('Превышено максимальное количество новых фото при редактировании: ' + photoInput.files.length);
          alert('Максимум 4 новых фото!');
          return;
        }
        
        this.showLoading(true);
        try {
          const order = this.orders.find(o => o.id === orderId);
          if (order) {
            order.full_name = formData.get('clientName');
            order.car_number = formData.get('carNumber');
            order.phone = formData.get('phone');
            order.service = formData.get('service');
            order.color = formData.get('color');
            order.notes = formData.get('note');
            order.cost = parseFloat(formData.get('cost'));
            
            // Обрабатываем новые фото
            const photoFiles = Array.from(photoInput.files);
            for (const file of photoFiles) {
              const compressedFile = await this.compressImage(file);
              const fileName = `photo_${Date.now()}_${Math.floor(Math.random() * 1000)}.jpg`;
              order.photos.push(fileName);
            }
            
            this.saveToLocalStorage();
            console.log(`Заказ ${orderId} успешно отредактирован`);
            document.getElementById('editModal').classList.remove('active');
            this.loadOrders(status);
          }
        } catch (error) {
          console.error(`Ошибка сохранения изменений заказа ${orderId}: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      removeExistingPhoto(orderId, photoPath, container) {
        container.remove();
        const order = this.orders.find(o => o.id === orderId);
        if (order) {
          order.photos = order.photos.filter(p => p !== photoPath);
          this.saveToLocalStorage();
        }
      },

      async addPhotos(orderId, status) {
        const modal = document.getElementById('addPhotosModal');
        modal.innerHTML = `
          <button class="modal-close-btn" onclick="App.closeModal(null, 'addPhotosModal')">×</button>
          <form id="add-photos-form" class="form modal-content">
            <input type="file" name="photos" id="add-photos-input" multiple accept="image/*" capture="environment">
            <div id="add-photos-preview" class="photo-preview"></div>
            <button type="submit">Добавить фото</button>
          </form>
        `;
        modal.classList.add('active');
        document.getElementById('add-photos-input').addEventListener('change', e => this.previewPhotos(e, 'add-photos-preview'));
        document.getElementById('add-photos-form').addEventListener('submit', e => this.saveAdditionalPhotos(e, orderId, status));
      },

      async saveAdditionalPhotos(e, orderId, status) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const photoInput = document.getElementById('add-photos-input');
        
        if (photoInput.files.length > 4) {
          console.warn('Превышено максимальное количество новых фото: ' + photoInput.files.length);
          alert('Максимум 4 фото!');
          return;
        }
        
        this.showLoading(true);
        try {
          const order = this.orders.find(o => o.id === orderId);
          if (order) {
            // Обрабатываем новые фото
            const photoFiles = Array.from(photoInput.files);
            for (const file of photoFiles) {
              const compressedFile = await this.compressImage(file);
              const fileName = `photo_${Date.now()}_${Math.floor(Math.random() * 1000)}.jpg`;
              order.photos.push(fileName);
            }
            
            this.saveToLocalStorage();
            console.log(`Добавлены фото к заказу ${orderId}`);
            document.getElementById('addPhotosModal').classList.remove('active');
            this.loadOrders(status);
          }
        } catch (error) {
          console.error(`Ошибка добавления фото к заказу ${orderId}: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      renderPagination(total, status) {
        const totalPages = Math.ceil(total / this.perPage);
        const list = document.getElementById(`${status === 'В работе' ? 'working' : status === 'Готово' ? 'done' : 'archive'}-list`);
        const pagination = document.createElement('div');
        pagination.className = 'pagination';
        pagination.innerHTML = `
          <button onclick="App.prevPage('${status}')" ${this.page === 1 ? 'disabled' : ''}>Назад</button>
          <span>Страница ${this.page} из ${totalPages}</span>
          <button onclick="App.nextPage('${status}', ${totalPages})" ${this.page === totalPages ? 'disabled' : ''}>Вперед</button>
        `;
        list.after(pagination);
      },

      prevPage(status) {
        if (this.page > 1) {
          this.page--;
          this.loadOrders(status);
        }
      },

      nextPage(status, totalPages) {
        if (this.page < totalPages) {
          this.page++;
          this.loadOrders(status);
        }
      },

      showImage(src) {
        const modal = document.getElementById('imageModal');
        document.getElementById('modalImage').src = src;
        modal.classList.add('active');
      },

      closeModal(e, modalId) {
        const modal = document.getElementById(modalId);
        if (e && modal.contains(e.target) && !modal.querySelector('.modal-content')?.contains(e.target)) {
          modal.classList.remove('active');
        } else if (!e) {
          modal.classList.remove('active');
        }
      },

      async searchOrders() {
        const query = document.getElementById('search-query').value.toLowerCase();
        const startDate = document.getElementById('search-start-date').value;
        const endDate = document.getElementById('search-end-date').value;
        
        if (!query && !startDate && !endDate) {
          console.warn('Попытка поиска без параметров');
          alert('Введите ключевое слово или укажите период для поиска');
          return;
        }
        
        this.showLoading(true);
        try {
          let results = [...this.orders];
          
          if (query) {
            results = results.filter(order => 
              order.full_name.toLowerCase().includes(query) ||
              (order.car_number && order.car_number.toLowerCase().includes(query)) ||
              (order.phone && order.phone.includes(query)) ||
              order.service.toLowerCase().includes(query) ||
              (order.notes && order.notes.toLowerCase().includes(query))
            );
          }
          
          if (startDate || endDate) {
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate + 'T23:59:59') : null;
            
            results = results.filter(order => {
              const orderDate = new Date(order.created_at);
              return (!start || orderDate >= start) && (!end || orderDate <= end);
            });
          }
          
          console.log(`Найдено ${results.length} заказов по запросу "${query || 'без ключевого слова'}"`);
          const list = document.getElementById('search-list');
          list.innerHTML = results.length ? '' : '<p>Ничего не найдено</p>';
          
          results.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card';
            
            const comments = order.comments ? order.comments.split(' | ').map(c => {
              const [date, rest] = c.split(': ');
              const [comment, username] = rest.split(' (');
              return `${date}: ${comment} (${username.slice(0, -1)})`;
            }).join('<br>') : 'Нет комментариев';
            
            const allPhotos = [...new Set([
              ...(order.photos || []),
              ...(order.finished_photos || [])
            ])];
            
            card.innerHTML = `
              <p><strong>Клиент:</strong> ${order.full_name}</p>
              <p><strong>Телефон:</strong> ${order.phone ? `<a href="tel:${order.phone}" style="color: #4a90e2;">${order.phone}</a>` : 'Не указан'}</p>
              <div class="photos">
                ${allPhotos.map(p => `<img src="${p}" onclick="App.showImage('${p}')">`).join('')}
              </div>
              <details>
                <summary>Подробности</summary>
                <p><strong>Заказ:</strong> ${order.id}</p>
                <p><strong>Госномер:</strong> ${order.car_number || 'Не указан'}</p>
                <p><strong>Услуги:</strong> ${order.service}</p>
                <p><strong>Стоимость:</strong> ${order.cost} руб</p>
                <p><strong>Статус:</strong> ${order.status}</p>
                <p><strong>Создан:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                <p><strong>Создал:</strong> ${order.created_by}</p>
                <p><strong>Примечания:</strong> ${order.notes || 'Нет примечаний'}</p>
                <p><strong>Комментарии:</strong> ${comments}</p>
              </details>
            `;
            list.appendChild(card);
          });
        } catch (error) {
          console.error(`Ошибка поиска: ${error.message}`);
          alert('Ошибка поиска: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async addExpense(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const amount = parseFloat(formData.get('amount'));
        const note = formData.get('note');
        
        this.showLoading(true);
        try {
          const newExpense = {
            id: Date.now(),
            amount: amount,
            note: note,
            created_at: new Date().toISOString()
          };
          
          this.expenses.unshift(newExpense);
          this.saveToLocalStorage();
          
          console.log(`Расход на сумму ${amount} руб добавлен`);
          e.target.reset();
          this.loadExpenses();
        } catch (error) {
          console.error(`Ошибка добавления расхода: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async loadExpenses() {
        this.showLoading(true);
        try {
          const list = document.getElementById('expenses-list');
          list.innerHTML = this.expenses.length ? '' : '<p>Нет расходов</p>';
          
          this.expenses.forEach(expense => {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.innerHTML = `
              <p><strong>Сумма:</strong> ${expense.amount} руб</p>
              <p><strong>Примечание:</strong> ${expense.note}</p>
              <p><strong>Дата:</strong> ${new Date(expense.created_at).toLocaleString()}</p>
            `;
            list.appendChild(card);
          });
        } catch (error) {
          console.error(`Ошибка загрузки расходов: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async generateIncomeReport(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const startDate = formData.get('startDate');
        const endDate = formData.get('endDate');
        
        if (!startDate || !endDate) {
          alert('Укажите начальную и конечную даты');
          return;
        }
        
        this.showLoading(true);
        try {
          const start = new Date(startDate);
          const end = new Date(endDate + 'T23:59:59');
          
          const filteredOrders = this.orders.filter(order => {
            const orderDate = new Date(order.created_at);
            return orderDate >= start && orderDate <= end;
          });
          
          const totalIncome = filteredOrders.reduce((sum, order) => sum + order.cost, 0);
          
          console.log(`Отчет о доходах сформирован: ${totalIncome} руб`);
          document.getElementById('report-result').innerHTML = `
            <p>Доход за период ${startDate} - ${endDate}: ${totalIncome} руб</p>
            <p>Количество заказов: ${filteredOrders.length}</p>
          `;
        } catch (error) {
          console.error(`Ошибка формирования отчета о доходах: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async generateExpenseReport(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const startDate = formData.get('startDate');
        const endDate = formData.get('endDate');
        
        if (!startDate || !endDate) {
          alert('Укажите начальную и конечную даты');
          return;
        }
        
        this.showLoading(true);
        try {
          const start = new Date(startDate);
          const end = new Date(endDate + 'T23:59:59');
          
          const filteredExpenses = this.expenses.filter(expense => {
            const expenseDate = new Date(expense.created_at);
            return expenseDate >= start && expenseDate <= end;
          });
          
          const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
          
          console.log(`Отчет о расходах сформирован: ${totalExpenses} руб`);
          document.getElementById('expense-report-result').innerHTML = `
            <p>Расходы за период ${startDate} - ${endDate}: ${totalExpenses} руб</p>
            <p>Количество расходов: ${filteredExpenses.length}</p>
          `;
        } catch (error) {
          console.error(`Ошибка формирования отчета о расходах: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      async generateProfitReport(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const startDate = formData.get('startDate');
        const endDate = formData.get('endDate');
        
        if (!startDate || !endDate) {
          alert('Укажите начальную и конечную даты');
          return;
        }
        
        this.showLoading(true);
        try {
          const start = new Date(startDate);
          const end = new Date(endDate + 'T23:59:59');
          
          // Доходы
          const filteredOrders = this.orders.filter(order => {
            const orderDate = new Date(order.created_at);
            return orderDate >= start && orderDate <= end;
          });
          const totalIncome = filteredOrders.reduce((sum, order) => sum + order.cost, 0);
          
          // Расходы
          const filteredExpenses = this.expenses.filter(expense => {
            const expenseDate = new Date(expense.created_at);
            return expenseDate >= start && expenseDate <= end;
          });
          const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
          
          const profit = totalIncome - totalExpenses;
          
          console.log(`Отчет о прибыли сформирован: доход ${totalIncome} руб, расходы ${totalExpenses} руб, прибыль ${profit} руб`);
          document.getElementById('profit-report-result').innerHTML = `
            <p>Доход за период ${startDate} - ${endDate}: ${totalIncome} руб</p>
            <p>Расходы: ${totalExpenses} руб</p>
            <p>Прибыль: ${profit} руб</p>
          `;
        } catch (error) {
          console.error(`Ошибка формирования отчета о прибыли: ${error.message}`);
          alert('Ошибка: ' + error.message);
        } finally {
          this.showLoading(false);
        }
      },

      showLoading(show) {
        const loading = document.getElementById('loading');
        loading.style.display = show ? 'block' : 'none';
        loading.style.opacity = show ? '1' : '0';
      }
    };

    App.init();
  </script>
</body>
</html>